#!/usr/bin/env python3
"""
Setup script for Metabase API configuration.

This script helps you configure your Metabase credentials securely.
"""

import os
from pathlib import Path


def setup_metabase_config():
    """Interactive setup for Metabase configuration."""
    print("ğŸ”§ Metabase Configuration Setup")
    print("=" * 40)
    
    config_file = Path("metabase_config.env")
    
    if config_file.exists():
        overwrite = input(f"âš ï¸  Configuration file '{config_file}' already exists. Overwrite? (y/N): ").lower().strip()
        if overwrite != 'y':
            print("âœ… Setup cancelled.")
            return
    
    print("\nğŸ“ Please provide your Metabase details:")
    
    # Get Metabase URL
    while True:
        base_url = input("ğŸŒ Metabase URL (e.g., https://your-company.metabase.com): ").strip()
        if base_url:
            # Remove trailing slash
            base_url = base_url.rstrip('/')
            break
        print("âŒ URL cannot be empty.")
    
    # Get API Key
    while True:
        api_key = input("ğŸ”‘ Metabase API Key: ").strip()
        if api_key:
            break
        print("âŒ API Key cannot be empty.")
    
    # Optional settings
    print("\nâš™ï¸  Optional settings (press Enter for defaults):")
    
    delay = input("â±ï¸  API delay between requests in seconds (default: 0.5): ").strip()
    if not delay:
        delay = "0.5"
    
    timeout = input("â±ï¸  Request timeout in seconds (default: 30): ").strip()
    if not timeout:
        timeout = "30"
    
    # Write configuration
    config_content = f"""# Metabase Configuration
# Generated by setup script

METABASE_BASE_URL={base_url}
METABASE_API_KEY={api_key}

# API Settings
API_DELAY_SECONDS={delay}
REQUEST_TIMEOUT_SECONDS={timeout}
"""
    
    try:
        with open(config_file, 'w') as f:
            f.write(config_content)
        
        print(f"\nâœ… Configuration saved to '{config_file}'")
        print("ğŸ”’ Keep this file secure and don't commit it to version control!")
        
        # Test configuration
        test_config = input("\nğŸ§ª Test the configuration now? (y/N): ").lower().strip()
        if test_config == 'y':
            print("\nğŸ” Testing configuration...")
            try:
                from metabase_api_fetcher import MetabaseAPIFetcher
                fetcher = MetabaseAPIFetcher()
                if fetcher.test_connection():
                    print("âœ… Configuration test successful!")
                else:
                    print("âŒ Configuration test failed. Please check your credentials.")
            except Exception as e:
                print(f"âŒ Error testing configuration: {str(e)}")
    
    except Exception as e:
        print(f"âŒ Error saving configuration: {str(e)}")


if __name__ == "__main__":
    setup_metabase_config() 